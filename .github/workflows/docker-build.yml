name: Docker build

on:
  workflow_dispatch:

env:
  SERVER: ${{ secrets.SERVER_IP }}
  USER: ${{ secrets.SERVER_USER }}
  PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

jobs:
    build:
      runs-on: ubuntu-latest
      steps:
      - uses: kielabokkie/ssh-key-and-known-hosts-action@v1
        with:
          ssh-private-key: $PRIVATE_KEY
          ssh-host: $SERVER
      - uses: actions/checkout@v2
      - name: Building docker image
        run: docker build . -t github-actions/backend
      - name: Export image
        run: docker save github-actions/backend | gzip > backend_image.tar.gz
      outputs:
        image: backend_image.tar.gz
        
    deploy:
      runs-on: ubuntu-latest
      needs: build
      steps: 
      - uses: kielabokkie/ssh-key-and-known-hosts-action@v1
        with:
          ssh-private-key: $PRIVATE_KEY
          ssh-host: $USER
      - name: Deploy to server
        run: scp backend_image.tar.gz $USER@$SERVER:/var/www/api

      
